
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4. Developers Guide &#8212; CICE-Consortium Icepack 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Index of primary variables and parameters" href="icepack_5_index.html" />
    <link rel="prev" title="3. User Guide" href="icepack_3_user_guide.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="icepack_5_index.html" title="5. Index of primary variables and parameters"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="icepack_3_user_guide.html" title="3. User Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CICE-Consortium Icepack 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="developers-guide">
<h1>4. Developers Guide<a class="headerlink" href="#developers-guide" title="Permalink to this headline">¶</a></h1>
<p>The Icepack model consists of three different parts, the column physics
code, the icepack driver, and the scripts.  Development of each of these
pieces will be described below separately.</p>
<div class="section" id="icepack-column-physics">
<span id="dev-colphys"></span><h2>4.1. Icepack Column Physics<a class="headerlink" href="#icepack-column-physics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="file-list">
<h3>4.1.1. File List<a class="headerlink" href="#file-list" title="Permalink to this headline">¶</a></h3>
<p>The column physics source code contains the following files</p>
<div class="line-block">
<div class="line"><strong>columnphysics/</strong>   the column physics code</div>
<div class="line-block">
<div class="line"><strong>icepack_aerosol.F90</strong>       handles most work associated with the aerosol tracers</div>
<div class="line"><strong>icepack_age.F90</strong>           handles most work associated with the age tracer</div>
<div class="line"><strong>icepack_algae.F90</strong>         biogeochemistry</div>
<div class="line"><strong>icepack_atmo.F90</strong>          stability-based parameterization for calculation of turbulent ice–atmosphere fluxes</div>
<div class="line"><strong>icepack_brine.F90</strong>         evolves the brine height tracer</div>
<div class="line"><strong>icepack_constants.F90</strong>     physical and numerical constants required for column package</div>
<div class="line"><strong>icepack_firstyear.F90</strong>     handles most work associated with the first-year ice area tracer</div>
<div class="line"><strong>icepack_flux.F90</strong>          fluxes needed/produced by the model</div>
<div class="line"><strong>icepack_intfc.F90</strong>         interface routines for linking Icepack with a host sea ice model</div>
<div class="line"><strong>icepack_itd.F90</strong>           utilities for managing ice thickness distribution</div>
<div class="line"><strong>icepack_kinds.F90</strong>         basic definitions of reals, integers, etc.</div>
<div class="line"><strong>icepack_mechred.F90</strong>       mechanical redistribution (ridging)</div>
<div class="line"><strong>icepack_meltpond_cesm.F90</strong> CESM melt pond parameterization</div>
<div class="line"><strong>icepack_meltpond_lvl.F90</strong>  level-ice melt pond parameterization</div>
<div class="line"><strong>icepack_meltpond_topo.F90</strong> topo melt pond parameterization</div>
<div class="line"><strong>icepack_mushy_physics.F90</strong> physics routines for mushy thermodynamics</div>
<div class="line"><strong>icepack_ocean.F90</strong>         mixed layer ocean model</div>
<div class="line"><strong>icepack_orbital.F90</strong>       orbital parameters for Delta-Eddington shortwave parameterization</div>
<div class="line"><strong>icepack_parameters.F90</strong>    basic model parameters</div>
<div class="line"><strong>icepack_shortwave.F90</strong>     shortwave and albedo parameterizations</div>
<div class="line"><strong>icepack_therm_0layer.F90</strong>  zero-layer thermodynamics of <a class="reference internal" href="zreferences.html#semtner76" id="id1">[40]</a></div>
<div class="line"><strong>icepack_therm_bl99.F90</strong>    multilayer thermodynamics of <a class="reference internal" href="zreferences.html#bl99" id="id2">[6]</a></div>
<div class="line"><strong>icepack_therm_itd.F90</strong>     thermodynamic changes mostly related to ice thickness distribution</div>
<div class="line"><strong>icepack_therm_mushy.F90</strong>   mushy-theory thermodynamics of <a class="reference internal" href="zreferences.html#thb13" id="id3">[47]</a></div>
<div class="line"><strong>icepack_therm_shared.F90</strong>  code shared by all thermodynamics parameterizations</div>
<div class="line"><strong>icepack_therm_vertical.F90</strong>  vertical growth rates and fluxes</div>
<div class="line"><strong>icepack_tracers.F90</strong>       tracer information</div>
<div class="line"><strong>icepack_warnings.F90</strong>      utilities for writing warning and error messages</div>
<div class="line"><strong>icepack_zbgc.F90</strong>          driver for ice biogeochemistry and brine tracer motion</div>
<div class="line"><strong>icepack_zbgc_shared.F90</strong>   parameters and shared code for biogeochemistry and brine height</div>
<div class="line"><strong>icepack_zsalinity.F90</strong>     vertical salinity parameterization of <a class="reference internal" href="zreferences.html#jhe11" id="id4">[22]</a></div>
</div>
</div>
</div>
<div class="section" id="coding-standard">
<h3>4.1.2. Coding Standard<a class="headerlink" href="#coding-standard" title="Permalink to this headline">¶</a></h3>
<p>The column physics is a library that solves the sea ice column physics on a
timestep by timestep and gridpoint by gridpoint basis.  It consists of Fortran routines with
input and output arguments.  The model state is saved in the host model.  There is no
communication between gridcells so the underlying implementation
supports no parallelization.  It however can be called in parallel by a driver
that is running on multiple pes with a decomposed grid.</p>
<p>The column physics does not have a time manager.  Calendaring is expected to be
dealt with by the host model.  The column physics does not read any forcing data,
that is passed into the column physics thru interfaces.  In fact,
there are no direct IO capabilities in the column physics.  That is to say, the
column physics does not open files to read or write.  The column physics is able to write
data via several different routines that specifically have a fortran unit number as an input
argument.  In addition, there is a warning package (see section <a class="reference internal" href="#warning"><span class="std std-ref">Calling Sequence</span></a>) that
provides the column package with the ability to store log output.  That output can
be queried by the host model or it can be written directly via a specific routine.
The warning package also provides access to an abort flag that the host model can
query after each call to check for successful completion of the column physics package.</p>
<p>All column physics public interfaces and public data are defined in the <strong>icepack_intfc.F90</strong>
file.  Internal column physics settings should all be accessible thru interfaces.
The internal constants, parameters, and tracer settings have init (set), query (get), and
write interfaces that provides access to internal column physics settings.  The host model
should not have to use “use” statements to access any of the column physics data outside
of what is provided thru the icepack_intfc module.
The public column physics interfaces use optional arguments where it makes sense and
there is an ongoing effort to make more of the interfaces support keyword=value arguments
for clarity and backwards compatibility.</p>
</div>
<div class="section" id="using-icepack">
<h3>4.1.3. Using Icepack<a class="headerlink" href="#using-icepack" title="Permalink to this headline">¶</a></h3>
<p>In this section, the various public icepack interfaces will be defined and
how to use them will be described.</p>
<div class="section" id="interfaces">
<h4>4.1.3.1. Interfaces<a class="headerlink" href="#interfaces" title="Permalink to this headline">¶</a></h4>
<p>Column physics data and subroutines are made public thru the <strong>icepack_intfc.F90</strong>
file.  That file contains the entire list of data and subroutines needed to
initialize, setup, and run the column physics package.  That file points
to other modules within the column physics where the interfaces are located.</p>
<p>Within <strong>icepack_intfc.F90</strong>, internal icepack kinds are defined via the
icepack_kinds module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_char_len</span>  <span class="o">=&gt;</span> <span class="n">char_len</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_char_len_long</span>  <span class="o">=&gt;</span> <span class="n">char_len_long</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_log_kind</span>  <span class="o">=&gt;</span> <span class="n">log_kind</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_int_kind</span>  <span class="o">=&gt;</span> <span class="n">int_kind</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_real_kind</span> <span class="o">=&gt;</span> <span class="n">real_kind</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_dbl_kind</span>  <span class="o">=&gt;</span> <span class="n">dbl_kind</span>
<span class="n">use</span> <span class="n">icepack_kinds</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_r16_kind</span>  <span class="o">=&gt;</span> <span class="n">r16_kind</span>
</pre></div>
</div>
<p>icepack_tracers defines a handful of parameters constants that provide information
about maximum array sizes for static dimensioning:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_nbtrcr</span> <span class="o">=&gt;</span> <span class="n">max_nbtrcr</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_algae</span>  <span class="o">=&gt;</span> <span class="n">max_algae</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_dic</span>    <span class="o">=&gt;</span> <span class="n">max_dic</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_doc</span>    <span class="o">=&gt;</span> <span class="n">max_doc</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_don</span>    <span class="o">=&gt;</span> <span class="n">max_don</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_fe</span>     <span class="o">=&gt;</span> <span class="n">max_fe</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_max_aero</span>   <span class="o">=&gt;</span> <span class="n">max_aero</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_nmodal1</span>    <span class="o">=&gt;</span> <span class="n">nmodal1</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">icepack_nmodal2</span>    <span class="o">=&gt;</span> <span class="n">nmodal2</span>
<span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_nspint</span>     <span class="o">=&gt;</span> <span class="n">nspint</span>
</pre></div>
</div>
<p>icepack_constants provides a list of static parameter constants:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">c0</span> <span class="o">=&gt;</span> <span class="n">c0</span>
</pre></div>
</div>
<p>icepack_constants provides init, query, write, and recompute methods to
define constant values.  These constants have defaults that the caller
can query or reset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_constants</span>
<span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_constants</span>
<span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_constants</span>
<span class="n">use</span> <span class="n">icepack_constants</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_recompute_constants</span>
</pre></div>
</div>
<p>icepack_parameters provides init, query, and write methods to
define model parameters.  These parameters have defaults that the caller
can query or reset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_parameters</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_parameters</span>
<span class="n">use</span> <span class="n">icepack_parameters</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_parameters</span>
<span class="n">use</span> <span class="n">icepack_parameters</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_parameters</span>
</pre></div>
</div>
<p>icepack_tracers provides init, query, and write methods to
define various tracer sizes, flags, indices, and numbers.  The
tracers have some defaults that the caller can query or reset:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_compute_tracers</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_tracer_sizes</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_tracer_sizes</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_tracer_flags</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_tracer_flags</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_tracer_flags</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_tracer_indices</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_tracer_indices</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_tracer_indices</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_tracer_numbers</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_query_tracer_numbers</span>
<span class="n">use</span> <span class="n">icepack_tracers</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_write_tracer_numbers</span>
</pre></div>
</div>
<p>icepack_itd provides three public interfaces to compute the ice
thickness distribution:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_itd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_itd</span>
<span class="n">use</span> <span class="n">icepack_itd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_itd_hist</span>
<span class="n">use</span> <span class="n">icepack_itd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_aggregate</span>
</pre></div>
</div>
<p>icepack_mechred contains two public interfaces to compute ridging
and ice strength:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_mechred</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_step_ridge</span>
<span class="n">use</span> <span class="n">icepack_mechred</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_ice_strength</span>
</pre></div>
</div>
<p>icepack_shortwave provides a routine to initialize the radiation
computation and an routine to update the radiation computation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_shortwave</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_prep_radiation</span>
<span class="n">use</span> <span class="n">icepack_shortwave</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_step_radiation</span>
</pre></div>
</div>
<p>icepack_brine address brine and zsalinity computations:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_brine</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_hbrine</span>
<span class="n">use</span> <span class="n">icepack_brine</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_zsalinity</span>
</pre></div>
</div>
<p>icepack_zbgc contains several public interfaces to support initialization
and computation for the skeletal layer bgc and zbgc options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_zbgc</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_bgc</span>
<span class="n">use</span> <span class="n">icepack_zbgc</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_zbgc</span>
<span class="n">use</span> <span class="n">icepack_zbgc</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_biogeochemistry</span>
<span class="n">use</span> <span class="n">icepack_zbgc</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_OceanConcArray</span>
<span class="n">use</span> <span class="n">icepack_zbgc</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_ocean_conc</span>
</pre></div>
</div>
<p>There are a couple of routines to support computation of an atmosphere
and ocean interaction:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_atmo</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_atm_boundary</span>
<span class="n">use</span> <span class="n">icepack_ocean</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_ocn_mixed_layer</span>
</pre></div>
</div>
<p>icepack_step_therm1 and icepack_step_therm2 compute the ice
thermodynamics in two steps:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_therm_vertical</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_step_therm1</span>
<span class="n">use</span> <span class="n">icepack_therm_itd</span>     <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_step_therm2</span>
</pre></div>
</div>
<p>icepack_therm_shared provides several methods to compute different
internal terms:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_ice_temperature</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_snow_temperature</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_liquidus_temperature</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_sea_freezing_temperature</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_enthalpy_snow</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_thermo</span>
<span class="n">use</span> <span class="n">icepack_therm_shared</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_trcr</span>
</pre></div>
</div>
<p>icepack_orbital provides a routine to set orbital parameters needed
for some albedo computations:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_orbital</span> <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_init_orbit</span>
</pre></div>
</div>
<p>icepack_warnings provides several methods for getting, writing,
and clearing messages.  There is also a function that returns
a logical flag indicating whether the column physics has aborted:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">icepack_warnings</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_warnings_clear</span>
<span class="n">use</span> <span class="n">icepack_warnings</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_warnings_getall</span>
<span class="n">use</span> <span class="n">icepack_warnings</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_warnings_print</span>
<span class="n">use</span> <span class="n">icepack_warnings</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_warnings_flush</span>
<span class="n">use</span> <span class="n">icepack_warnings</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">icepack_warnings_aborted</span>
</pre></div>
</div>
<p>icepack_configure is a standalone icepack method that should always be called
first:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="p">::</span> <span class="n">icepack_configure</span>
</pre></div>
</div>
</div>
<div class="section" id="calling-sequence">
<span id="warning"></span><h4>4.1.3.2. Calling Sequence<a class="headerlink" href="#calling-sequence" title="Permalink to this headline">¶</a></h4>
<p>The calling sequence required to setup and run the column physics is generally
described below.  Several steps may be needed to be taken by the host between
icepack calls in order to support the icepack interfaces.
The icepack driver and the CICE model provide working examples
of how to do this in practice.  The sample below does not include bgc.</p>
<p>start driver</p>
<ul class="simple">
<li>call <em>icepack_configure</em></li>
</ul>
<p>initialize driver and read in driver namelist</p>
<ul class="simple">
<li>call <em>icepack_init_constants</em></li>
<li>call <em>icepack_init_parameters</em></li>
<li>call <em>icepack_init_tracers_</em></li>
<li>call <em>icepack_init_trcr</em></li>
<li>call <em>icepack_init_thermo</em></li>
<li>call <em>icepack_init_itd</em></li>
<li>call <em>icepack_init_itd_hist</em></li>
<li>call <em>icepack_step_radiation</em></li>
<li>call <em>icepack_init_zsalinity</em></li>
<li>call <em>icepack_init_hbrine</em></li>
<li>call <em>icepack_aggregate</em></li>
</ul>
<p>loop over timesteps
loop over gridcells</p>
<ul class="simple">
<li>call <em>icepack_prep_radiation</em></li>
<li>call <em>icepack_step_therm1</em></li>
<li>call <em>icepack_step_therm2</em></li>
<li>call <em>icepack_aggregate</em></li>
<li>call <em>icepack_step_ridge</em></li>
<li>call <em>icepack_step_radiation</em></li>
<li>call <em>icepack_atm_boundary</em></li>
<li>call <em>icepack_ocn_mixed_layer</em></li>
</ul>
<p>end loop over gridcells
end loop over timesteps</p>
<p>end driver</p>
</div>
<div class="section" id="the-warning-package">
<h4>4.1.3.3. The Warning Package<a class="headerlink" href="#the-warning-package" title="Permalink to this headline">¶</a></h4>
<p>Icepack has no IO capabilities.  It does not have direct knowledge of
any input or output files.  However, it can write output thru specific
interfaces that pass in a fortran file unit number.  There are several
methods in icepack that support writing data to a file this way including
the various <em>icepack_write_</em> interfaces.</p>
<p>Separately, the icepack warning package is where icepack stores internal output and
error messages not directly set in the various write routines.  The warning package
also contains an <em>icepack_warnings_aborted</em> function that will be set to true
if icepack detects an abort.  In that case, icepack will return to the driver.
As a general rule, after each call to icepack, the driver should call:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">icepack_warnings_flush</span><span class="p">(</span><span class="n">nu_diag</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">icepack_warnings_aborted</span><span class="p">())</span> <span class="n">call</span> <span class="n">icedrv_system_abort</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">subname</span><span class="p">,</span> <span class="o">&amp;</span>
    <span class="n">file</span><span class="o">=</span><span class="n">__FILE__</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">__LINE__</span><span class="p">)</span>
</pre></div>
</div>
<p>to flush (print and clear) the icepack warning buffer and to check whether icepack
aborted.  If icepack aborts, it’s actually up to the driver to cleanly shut the
model down.</p>
<p>Alternatively, <em>icepack_warnings_getall</em> provides the saved icepack messages to
the driver via an array of strings in the argument list.  This allows the driver
to reformat that output as needed.  <em>icepack_warnings_print</em>
writes out the messages but does not clear them, and <em>icepack_warnings_clear</em> zeros
out the icepack warning messages.</p>
</div>
</div>
</div>
<div class="section" id="driver-implementation">
<span id="dev-driver"></span><h2>4.2. Driver Implementation<a class="headerlink" href="#driver-implementation" title="Permalink to this headline">¶</a></h2>
<p>The icepack driver is Fortran source code and exists to test the column physics
in a stand-alone mode for some simple column configurations.</p>
<div class="section" id="id5">
<h3>4.2.1. File List<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>The icepack driver consists of the following files</p>
<div class="line-block">
<div class="line"><strong>configuration/driver/</strong>       driver for testing Icepack in stand-alone mode</div>
<div class="line-block">
<div class="line"><strong>icedrv_MAIN.F90</strong>        main program</div>
<div class="line"><strong>icedrv_InitMod.F90</strong>     routines for initializing a run</div>
<div class="line"><strong>icedrv_RunMod.F90</strong>      main driver routines for time stepping</div>
<div class="line"><strong>icedrv_arrays_column.F90</strong>    essential arrays to describe the state of the ice</div>
<div class="line"><strong>icedrv_calendar.F90</strong>    keeps track of what time it is</div>
<div class="line"><strong>icedrv_constants.F90</strong>   physical and numerical constants and parameters</div>
<div class="line"><strong>icedrv_diagnostics.F90</strong> miscellaneous diagnostic and debugging routines</div>
<div class="line"><strong>icedrv_diagnostics_bgc.F90</strong>  diagnostic routines for biogeochemistry</div>
<div class="line"><strong>icedrv_domain_size.F90</strong> domain sizes</div>
<div class="line"><strong>icedrv_flux.F90</strong>        fluxes needed/produced by the model</div>
<div class="line"><strong>icedrv_forcing.F90</strong>     routines to read and interpolate forcing data for stand-alone model runs</div>
<div class="line"><strong>icedrv_forcing_bgc.F90</strong> routines to read and interpolate forcing data for bgc stand-alone model runs</div>
<div class="line"><strong>icedrv_init.F90</strong>        general initialization routines</div>
<div class="line"><strong>icedrv_init_column.F90</strong> initialization routines specific to the column physics</div>
<div class="line"><strong>icedrv_restart.F90</strong>     driver for reading/writing restart files</div>
<div class="line"><strong>icedrv_restart_column.F90</strong>  (CHECK: RENAME bgc) restart routines specific to the column physics</div>
<div class="line"><strong>icedrv_restart_shared.F90</strong>  code shared by all restart options</div>
<div class="line"><strong>icedrv_state.F90</strong>       essential arrays to describe the state of the ice</div>
<div class="line"><strong>icedrv_step.F90</strong>        routines for time stepping the major code components</div>
<div class="line"><strong>icedrv_system.F90</strong>      overall system management calls</div>
</div>
</div>
</div>
<div class="section" id="overview">
<h3>4.2.2. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>The icepack driver exists to test the column physics.  At the present time, it is hardwired
to run 4 different gridcells on one processor with the same forcing used for all gridcells.
There is no MPI and no threading built into the icepack driver.  There is limited IO capabilities,
no history files, and no netcdf restart files.  The model generally runs very quickly.</p>
<p>There are a few different forcings available.</p>
</div>
</div>
<div class="section" id="scripts-implementation">
<span id="dev-scripts"></span><h2>4.3. Scripts Implementation<a class="headerlink" href="#scripts-implementation" title="Permalink to this headline">¶</a></h2>
<p>The scripts are the third part of the icepack package.  They support setting up
cases, building, and running the icepack stand-alone model.</p>
<div class="section" id="id6">
<h3>4.3.1. File List<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The directory structure under configure/scripts is as follows.</p>
<div class="line-block">
<div class="line"><strong>configuration/scripts/</strong></div>
<div class="line-block">
<div class="line"><strong>Makefile</strong>              primary makefile</div>
<div class="line"><strong>icepack.batch.csh</strong>     creates batch scripts for particular machines</div>
<div class="line"><strong>icepack.build</strong>         compiles the code</div>
<div class="line"><strong>icepack.launch.csh</strong>    creates script logic that runs the executable</div>
<div class="line"><strong>icepack.run.setup.csh</strong> sets up the run scripts</div>
<div class="line"><strong>icepack.run.suite.csh</strong> sets up the test suite</div>
<div class="line"><strong>icepack.settings</strong>      defines environment, model configuration and run settings</div>
<div class="line"><strong>icepack.test.setup.csh</strong>   creates configurations for testing the model</div>
<div class="line"><strong>icepack_decomp.csh</strong>    defines the grid size</div>
<div class="line"><strong>icepack_in</strong>            namelist input data</div>
<div class="line"><strong>machines/</strong>             machine specific files to set env and Macros</div>
<div class="line"><strong>makdep.c</strong>              determines module dependencies</div>
<div class="line"><strong>options/</strong>              other namelist configurations available from the icepack.create.case command line</div>
<div class="line"><strong>parse_namelist.sh</strong>     replaces namelist with command-line configuration</div>
<div class="line"><strong>parse_namelist_from_settings.sh</strong>   replaces namelist with values from icepack.settings</div>
<div class="line"><strong>parse_settings.sh</strong>     replaces settings with command-line configuration</div>
<div class="line"><strong>tests/</strong>                scripts for configuring and running basic tests</div>
</div>
</div>
<p>:: _dev_strategy:</p>
</div>
<div class="section" id="strategy">
<h3>4.3.2. Strategy<a class="headerlink" href="#strategy" title="Permalink to this headline">¶</a></h3>
<p>The icepack scripts are implemented such that everything is resolved after
<strong>icepack.create.case</strong> is called.  This is done by both copying specific files
into the case directory and running scripts as part of the <strong>icepack.create.case</strong>
command line to setup various files.</p>
<p><strong>icepack.create.case</strong> drives the case setup.  It is written in csh.  All supporting
scripts are relatively simple csh or sh scripts.</p>
<p>The file <strong>icepack.settings</strong> specifies a set of env defaults for the case.  The file
<strong>icepack_in</strong> defines the namelist input for the icepack driver.</p>
<p>:: _dev_options:</p>
</div>
<div class="section" id="preset-case-options">
<h3>4.3.3. Preset Case Options<a class="headerlink" href="#preset-case-options" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">icepack.create.case</span> <span class="pre">-s</span></code> option allows the user to choose some predetermined icepack
settings and namelist.  Those options are defined in <strong>configurations/scripts/options/</strong>
and the files are prefixed by either set_env, set_nml, or test_nml.  When <strong>icepack.create.case</strong>
is executed, the appropriate files are read from <strong>configurations/scripts/options/</strong>
and the <strong>icepack.settings</strong> and/or <strong>icepack_in</strong> files are updated in the case directory
based on the values in those files.</p>
<p>The filename suffix determines the name of the -s option.  So, for instance,</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">icepack.create.case</span> <span class="pre">-s</span> <span class="pre">diag1,debug,bgcISPOL</span></code></div></blockquote>
<p>will search for option files with suffixes of diag1, debug, and bgcISPOL and then
apply those settings.</p>
<p><strong>parse_namelist.sh</strong>, <strong>parse_settings.sh</strong>, and <strong>parse_namelist_from_settings.sh</strong>
are the three scripts that modify <strong>icepack_in</strong> and <strong>icepack.settings</strong>.</p>
<p>To add new options, just add new files to the <strong>configurations/scripts/options/</strong> directory
with appropriate names and syntax.  The set_nml file syntax is the same as namelist
syntax and the set_env files are consistent with csh setenv syntax.  See other files for
examples of the syntax.</p>
<p>:: _dev_machines:</p>
</div>
<div class="section" id="machines">
<h3>4.3.4. Machines<a class="headerlink" href="#machines" title="Permalink to this headline">¶</a></h3>
<p>Machine specific information is contained in <strong>configuration/scripts/machines</strong>.  That
directory contains a Macros file and an env file for each supported machine.
One other files will need to be
changed to support a port, that is <strong>configuration/scripts/icepack.batch.csh</strong>.
To port to a new machine, see <a class="reference internal" href="icepack_3_user_guide.html#porting"><span class="std std-ref">Porting</span></a>.</p>
<p>:: _dev_testing:</p>
</div>
<div class="section" id="test-scripts">
<h3>4.3.5. Test scripts<a class="headerlink" href="#test-scripts" title="Permalink to this headline">¶</a></h3>
<p>Under <strong>configuration/scripts/tests</strong> are several files including the scripts to
setup the smoke and restart tests (<strong>test_smoke.script</strong>, <strong>test_restart.script*).
A baseline test script (**baseline.script</strong>) is also there to setup the regression
and comparison testing.  That directory also contains the preset test suites
(ie. <strong>base_suite.ts</strong>) and a file that supports post-processing on the model
output (<strong>timeseries.csh</strong>).</p>
<p>There is a subdirectory, <strong>configuration/scripts/tests/CTest</strong>, that supports the
CTest scripts.  These scripts allow test reporting to CDash.</p>
<p>To add a new test, a file associated with that test will need to be added to the
<strong>configuration/scripts/tests</strong> directory similar to <strong>test_smoke.script</strong>
and <strong>test_restart.script</strong>.  In addition, some new options files in
<strong>configuration/scripts/options</strong> may need to be added similar to <strong>test_nml.restart1</strong>,
<strong>test_nml.restart2</strong>, and <strong>set_nml.restart</strong>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Developers Guide</a><ul>
<li><a class="reference internal" href="#icepack-column-physics">4.1. Icepack Column Physics</a><ul>
<li><a class="reference internal" href="#file-list">4.1.1. File List</a></li>
<li><a class="reference internal" href="#coding-standard">4.1.2. Coding Standard</a></li>
<li><a class="reference internal" href="#using-icepack">4.1.3. Using Icepack</a><ul>
<li><a class="reference internal" href="#interfaces">4.1.3.1. Interfaces</a></li>
<li><a class="reference internal" href="#calling-sequence">4.1.3.2. Calling Sequence</a></li>
<li><a class="reference internal" href="#the-warning-package">4.1.3.3. The Warning Package</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#driver-implementation">4.2. Driver Implementation</a><ul>
<li><a class="reference internal" href="#id5">4.2.1. File List</a></li>
<li><a class="reference internal" href="#overview">4.2.2. Overview</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scripts-implementation">4.3. Scripts Implementation</a><ul>
<li><a class="reference internal" href="#id6">4.3.1. File List</a></li>
<li><a class="reference internal" href="#strategy">4.3.2. Strategy</a></li>
<li><a class="reference internal" href="#preset-case-options">4.3.3. Preset Case Options</a></li>
<li><a class="reference internal" href="#machines">4.3.4. Machines</a></li>
<li><a class="reference internal" href="#test-scripts">4.3.5. Test scripts</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="icepack_3_user_guide.html"
                        title="previous chapter">3. User Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="icepack_5_index.html"
                        title="next chapter">5. Index of primary variables and parameters</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/icepack_4_developer_guide.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="icepack_5_index.html" title="5. Index of primary variables and parameters"
             >next</a></li>
        <li class="right" >
          <a href="icepack_3_user_guide.html" title="3. User Guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CICE-Consortium Icepack 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Los Alamos National Security, LLC (code) and National Center for Atmospheric Research (documentation).
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>